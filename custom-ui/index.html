<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ossuary Setup</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Sora:wght@600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --paper: #f5f1eb; --paper-warm: #faf6f0; --paper-dark: #e8e4de;
            --ink: #1a1a1a; --ink-soft: #3a3a3a; --ink-muted: #6a6a6a;
            --teal: #0d9488; --teal-dark: #0f766e; --teal-light: #5eead4;
            --teal-muted: rgba(13, 148, 136, 0.1);
            --lc-blue: #8ED3EF; --lc-blue-muted: rgba(142, 211, 239, 0.15);
            --border: rgba(26, 26, 26, 0.15);
            --success: #059669; --success-bg: rgba(5, 150, 105, 0.1);
            --error: #dc2626; --error-bg: rgba(220, 38, 38, 0.1);
            --warning: #d97706; --warning-bg: rgba(217, 119, 6, 0.1);
            --space-xs: 4px; --space-sm: 8px; --space-md: 12px;
            --space-lg: 16px; --space-xl: 24px;
        }

        [data-theme="dark"] {
            --paper: #1a1a1a; --paper-warm: #222222; --paper-dark: #2a2a2a;
            --ink: #f5f1eb; --ink-soft: #c5c5c5; --ink-muted: #888888;
            --teal: #14b8a6; --teal-muted: rgba(20, 184, 166, 0.15);
            --border: rgba(255, 255, 255, 0.12);
        }

        body {
            font-family: 'IBM Plex Mono', monospace;
            background: var(--paper); color: var(--ink);
            line-height: 1.6; font-size: 14px;
            min-height: 100vh; padding: var(--space-lg);
        }

        body::after {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.025; pointer-events: none; z-index: 9999;
        }

        .container {
            background: var(--paper-warm); border: 1px solid var(--ink);
            max-width: 560px; width: 100%; margin: 0 auto; position: relative;
        }

        .container::before, .container::after {
            content: ''; position: absolute; width: 12px; height: 12px;
            border: 1px solid var(--teal);
        }
        .container::before { top: -6px; left: -6px; border-right: none; border-bottom: none; }
        .container::after { bottom: -6px; right: -6px; border-left: none; border-top: none; }

        /* Header */
        .header {
            padding: var(--space-xl); border-bottom: 1px solid var(--ink);
            display: flex; align-items: center; gap: var(--space-lg);
        }
        .header-logo { width: 48px; height: 48px; flex-shrink: 0; }
        .header-content { flex: 1; }
        .header-label {
            font-family: 'Space Mono', monospace; font-size: 10px;
            text-transform: uppercase; letter-spacing: 2px; color: var(--teal);
            margin-bottom: var(--space-xs); display: flex; align-items: center; gap: 10px;
        }
        .header-label::before { content: ''; width: 20px; height: 1px; background: var(--teal); }
        .header h1 {
            font-family: 'Sora', sans-serif; font-size: 22px; font-weight: 700;
            letter-spacing: -0.5px; margin-bottom: 2px;
        }
        .header p { font-size: 12px; color: var(--ink-muted); }

        /* Tabs */
        .tab-container { display: flex; border-bottom: 1px solid var(--ink); overflow-x: auto; }
        .tab {
            flex: 1; min-width: 80px; padding: var(--space-md) var(--space-sm);
            font-family: 'Space Mono', monospace; font-size: 10px;
            text-transform: uppercase; letter-spacing: 0.5px;
            background: var(--paper); border: none; border-right: 1px solid var(--ink);
            color: var(--ink-muted); cursor: pointer; transition: all 0.15s;
            white-space: nowrap;
        }
        .tab:last-child { border-right: none; }
        .tab:hover { background: var(--teal-muted); color: var(--ink); }
        .tab.active {
            background: var(--teal-muted); color: var(--teal);
            border-bottom: 2px solid var(--teal); margin-bottom: -1px;
        }

        .tab-content { display: none; padding: var(--space-xl); }
        .tab-content.active { display: block; }

        /* Form elements */
        .section-label {
            font-family: 'Space Mono', monospace; font-size: 10px;
            text-transform: uppercase; letter-spacing: 1px; color: var(--ink-muted);
            margin-bottom: var(--space-sm);
        }
        .input-group { margin-bottom: var(--space-lg); }
        .input-group label {
            display: block; font-family: 'Space Mono', monospace; font-size: 10px;
            text-transform: uppercase; letter-spacing: 1px; color: var(--ink-muted);
            margin-bottom: var(--space-sm);
        }
        input, textarea, select {
            width: 100%; padding: var(--space-md);
            font-family: 'IBM Plex Mono', monospace; font-size: 13px;
            background: var(--paper); border: 1px solid var(--border); color: var(--ink);
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--teal); }
        input::placeholder, textarea::placeholder { color: var(--ink-muted); }
        textarea { resize: vertical; min-height: 80px; }
        select { cursor: pointer; }

        /* Buttons */
        .btn-primary {
            font-family: 'Space Mono', monospace; font-size: 11px;
            text-transform: uppercase; letter-spacing: 0.5px;
            padding: var(--space-md) var(--space-lg);
            background: var(--teal); border: 1px solid var(--teal); color: white;
            cursor: pointer; width: 100%; transition: all 0.15s;
        }
        .btn-primary:hover { background: var(--teal-dark); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary {
            font-family: 'Space Mono', monospace; font-size: 11px;
            text-transform: uppercase; letter-spacing: 0.5px;
            padding: var(--space-md) var(--space-lg);
            background: transparent; border: 1px solid var(--border); color: var(--ink);
            cursor: pointer; width: 100%; margin-top: var(--space-sm);
        }
        .btn-secondary:hover { border-color: var(--ink); }

        .btn-small {
            font-family: 'Space Mono', monospace; font-size: 9px;
            text-transform: uppercase; padding: var(--space-xs) var(--space-sm);
            background: var(--paper-dark); border: 1px solid var(--border); color: var(--ink);
            cursor: pointer;
        }
        .btn-small:hover { border-color: var(--teal); color: var(--teal); }
        .btn-small.danger:hover { border-color: var(--error); color: var(--error); }

        /* Messages & Info */
        .message {
            padding: var(--space-md); margin-bottom: var(--space-lg); font-size: 12px;
            display: none; border-left: 3px solid;
        }
        .message.success { background: var(--success-bg); color: var(--success); border-color: var(--success); }
        .message.error { background: var(--error-bg); color: var(--error); border-color: var(--error); }
        .message.show { display: block; }

        .info-box {
            background: var(--paper); border-left: 3px solid var(--teal);
            padding: var(--space-md); margin-top: var(--space-lg);
        }
        .info-box h3 {
            font-family: 'Space Mono', monospace; font-size: 10px;
            text-transform: uppercase; letter-spacing: 1px; color: var(--teal);
            margin-bottom: var(--space-xs);
        }
        .info-box p { font-size: 12px; color: var(--ink-muted); line-height: 1.5; }
        .info-box code {
            font-family: 'IBM Plex Mono', monospace;
            background: var(--paper-dark); padding: 2px 6px; font-size: 12px; color: var(--teal);
        }

        /* Network list */
        .network-list { max-height: 200px; overflow-y: auto; margin-bottom: var(--space-lg); border: 1px solid var(--border); }
        .network-item {
            padding: var(--space-md); background: var(--paper);
            border-bottom: 1px solid var(--border); cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .network-item:last-child { border-bottom: none; }
        .network-item:hover { background: var(--teal-muted); }
        .network-item.selected { background: var(--teal-muted); border-left: 3px solid var(--teal); }
        .network-name { font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; }
        .network-meta { font-size: 10px; color: var(--ink-muted); margin-top: 2px; }
        .network-icon { color: var(--ink-muted); display: flex; align-items: center; }
        .network-icon svg { width: 18px; height: 18px; }
        .network-actions { display: flex; gap: var(--space-xs); }

        /* Saved networks */
        .saved-network-item {
            padding: var(--space-md); background: var(--paper); border: 1px solid var(--border);
            margin-bottom: var(--space-sm); display: flex; justify-content: space-between; align-items: center;
        }
        .saved-network-info { flex: 1; }
        .saved-network-ssid { font-family: 'Space Mono', monospace; font-weight: 700; font-size: 13px; }
        .saved-network-notes { font-size: 11px; color: var(--ink-muted); margin-top: 2px; }
        .saved-network-meta { font-size: 10px; color: var(--ink-muted); margin-top: 4px; }

        /* Presets */
        .preset-grid { display: flex; flex-direction: column; gap: var(--space-md); margin-bottom: var(--space-lg); }
        .preset-card {
            background: var(--paper); border: 1px solid var(--border);
            padding: var(--space-lg); cursor: pointer; display: flex;
            align-items: center; gap: var(--space-lg);
        }
        .preset-card:hover { border-color: var(--teal); background: var(--teal-muted); }
        .preset-card.lumencanvas { border-color: var(--lc-blue); }
        .preset-card.lumencanvas:hover { background: var(--lc-blue-muted); }
        .preset-icon { width: 40px; height: 40px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .preset-icon svg { width: 40px; height: 40px; }
        .preset-content { flex: 1; }
        .preset-name { font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .preset-desc { font-size: 11px; color: var(--ink-muted); }
        .preset-tags { display: flex; gap: var(--space-xs); margin-top: var(--space-xs); }
        .preset-tag {
            font-family: 'Space Mono', monospace; font-size: 9px;
            text-transform: uppercase; letter-spacing: 0.5px;
            padding: 2px 6px; background: var(--paper-dark); color: var(--ink-muted);
        }

        /* Config panels */
        .config-panel { display: none; border: 1px solid var(--border); padding: var(--space-lg); margin-bottom: var(--space-lg); background: var(--paper); }
        .config-panel.active { display: block; }
        .config-panel h4 {
            font-family: 'Space Mono', monospace; font-size: 11px;
            text-transform: uppercase; letter-spacing: 1px; color: var(--teal);
            margin-bottom: var(--space-md); padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border);
        }
        .checkbox-group { display: flex; flex-direction: column; gap: var(--space-sm); margin-bottom: var(--space-lg); }
        .checkbox-item { display: flex; align-items: center; gap: var(--space-sm); cursor: pointer; }
        .checkbox-item input[type="checkbox"] { width: auto; margin: 0; }
        .checkbox-item label { margin: 0; font-size: 12px; color: var(--ink-soft); cursor: pointer; }
        .back-link {
            font-family: 'Space Mono', monospace; font-size: 11px;
            color: var(--ink-muted); cursor: pointer; margin-bottom: var(--space-lg); display: inline-block;
        }
        .back-link:hover { color: var(--teal); }

        /* Schedule */
        .schedule-list { margin-bottom: var(--space-lg); }
        .schedule-item {
            padding: var(--space-md); background: var(--paper); border: 1px solid var(--border);
            margin-bottom: var(--space-sm); display: flex; justify-content: space-between; align-items: center;
        }
        .schedule-item.disabled { opacity: 0.5; }
        .schedule-info { flex: 1; }
        .schedule-name { font-family: 'Space Mono', monospace; font-weight: 700; font-size: 13px; }
        .schedule-details { font-size: 11px; color: var(--ink-muted); margin-top: 4px; }
        .schedule-time { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--teal); }
        .schedule-days { display: flex; gap: 2px; margin-top: var(--space-xs); }
        .schedule-day {
            font-family: 'Space Mono', monospace; font-size: 9px;
            padding: 2px 4px; background: var(--paper-dark); color: var(--ink-muted);
        }
        .schedule-day.active { background: var(--teal-muted); color: var(--teal); }

        /* Day picker */
        .day-picker { display: flex; gap: var(--space-xs); margin: var(--space-sm) 0; }
        .day-btn {
            font-family: 'Space Mono', monospace; font-size: 10px;
            padding: var(--space-sm) var(--space-md);
            background: var(--paper); border: 1px solid var(--border);
            cursor: pointer; color: var(--ink-muted);
        }
        .day-btn:hover { border-color: var(--teal); }
        .day-btn.selected { background: var(--teal-muted); border-color: var(--teal); color: var(--teal); }

        /* Time input */
        .time-input-group { display: flex; gap: var(--space-sm); align-items: center; }
        .time-input-group input[type="time"] { width: auto; flex: 1; }
        .time-input-group span { font-size: 12px; color: var(--ink-muted); }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--paper-warm); border: 1px solid var(--ink);
            max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto;
        }
        .modal-header {
            padding: var(--space-lg); border-bottom: 1px solid var(--ink);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h3 { font-family: 'Sora', sans-serif; font-size: 16px; font-weight: 600; }
        .modal-close {
            background: none; border: none; font-size: 20px; cursor: pointer; color: var(--ink-muted);
        }
        .modal-body { padding: var(--space-lg); }
        .modal-footer { padding: var(--space-lg); border-top: 1px solid var(--border); }

        /* Timezone */
        .timezone-display {
            font-family: 'Space Mono', monospace; font-size: 12px;
            padding: var(--space-md); background: var(--paper); border: 1px solid var(--border);
            margin-bottom: var(--space-lg);
        }
        .timezone-label { font-size: 10px; text-transform: uppercase; color: var(--ink-muted); margin-bottom: 4px; }
        .timezone-value { color: var(--teal); font-weight: 700; }

        /* Empty state */
        .empty-state { text-align: center; padding: var(--space-xl); color: var(--ink-muted); font-size: 12px; }

        /* Spinner */
        .spinner {
            display: none; border: 2px solid var(--border); border-top: 2px solid var(--teal);
            width: 24px; height: 24px; animation: spin 0.8s linear infinite; margin: var(--space-lg) auto;
        }
        .spinner.show { display: block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 500px) {
            body { padding: var(--space-sm); }
            .container::before, .container::after { display: none; }
            .header { flex-direction: column; text-align: center; padding: var(--space-lg); }
            .header-label::before { display: none; }
            .tab { font-size: 9px; padding: var(--space-sm); }
            .day-picker { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <svg class="header-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs><clipPath id="canvasClip"><rect x="0" y="0" width="50" height="100"/><rect x="50" y="50" width="50" height="50"/></clipPath></defs>
                <rect x="0" y="0" width="100" height="100" fill="#000"/>
                <rect x="0" y="0" width="50" height="100" fill="#fff"/>
                <rect x="50" y="50" width="50" height="50" fill="#fff"/>
                <polygon points="0,0 50,50 0,100" fill="#8ED3EF" clip-path="url(#canvasClip)"/>
            </svg>
            <div class="header-content">
                <div class="header-label">Kiosk Setup</div>
                <h1>Ossuary</h1>
                <p>Configure your display</p>
            </div>
        </div>

        <div class="tab-container">
            <button class="tab active" onclick="switchTab('wifi')">WiFi</button>
            <button class="tab" onclick="switchTab('networks')">Networks</button>
            <button class="tab" onclick="switchTab('display')">Display</button>
            <button class="tab" onclick="switchTab('schedule')">Schedule</button>
        </div>

        <!-- WiFi Tab -->
        <div id="wifi-tab" class="tab-content active">
            <div id="wifi-message" class="message"></div>

            <div class="input-group">
                <label>Nearby Networks</label>
                <div class="network-list" id="nearby-networks">
                    <div class="spinner show"></div>
                </div>
            </div>

            <form onsubmit="connectWiFi(); return false;" autocomplete="on">
                <div class="input-group">
                    <label for="wifi-ssid">Network Name</label>
                    <input type="text" id="wifi-ssid" name="ssid" placeholder="Enter SSID manually" autocomplete="username">
                </div>

                <div class="input-group">
                    <label for="wifi-password">Password</label>
                    <input type="password" id="wifi-password" name="password" placeholder="Leave empty for open networks" autocomplete="current-password">
                </div>

                <button type="submit" class="btn-primary" id="wifi-connect-btn">Connect</button>
                <button type="button" class="btn-secondary" onclick="loadNearbyNetworks()">Refresh Networks</button>
            </form>

            <div class="info-box">
                <h3>After Connecting</h3>
                <p>Access config at: <code id="config-url">http://loading...</code></p>
            </div>
        </div>

        <!-- Saved Networks Tab -->
        <div id="networks-tab" class="tab-content">
            <p class="section-label">Saved Networks</p>
            <div id="saved-networks-list"></div>

            <button class="btn-primary" onclick="showAddNetworkModal()">Add Network</button>

            <div class="info-box">
                <h3>Pre-configure Networks</h3>
                <p>Add networks before arriving at a venue. The device will auto-connect when in range.</p>
            </div>
        </div>

        <!-- Display Tab -->
        <div id="display-tab" class="tab-content">
            <div id="preset-view">
                <p class="section-label">What will this kiosk display?</p>
                <div class="preset-grid">
                    <div class="preset-card lumencanvas" onclick="selectPreset('lumencanvas')">
                        <div class="preset-icon">
                            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                <rect x="0" y="0" width="100" height="100" fill="#000"/>
                                <rect x="0" y="0" width="50" height="100" fill="#fff"/>
                                <rect x="50" y="50" width="50" height="50" fill="#fff"/>
                                <polygon points="0,0 50,50 0,100" fill="#8ED3EF"/>
                            </svg>
                        </div>
                        <div class="preset-content">
                            <div class="preset-name">LumenCanvas</div>
                            <div class="preset-desc">Display a LumenCanvas project</div>
                            <div class="preset-tags">
                                <span class="preset-tag">WebGPU</span>
                                <span class="preset-tag">Kiosk</span>
                            </div>
                        </div>
                    </div>

                    <div class="preset-card" onclick="selectPreset('webgpu')">
                        <div class="preset-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                        </div>
                        <div class="preset-content">
                            <div class="preset-name">Web Kiosk</div>
                            <div class="preset-desc">Any URL in fullscreen</div>
                            <div class="preset-tags"><span class="preset-tag">WebGPU</span></div>
                        </div>
                    </div>

                    <div class="preset-card" onclick="selectPreset('custom')">
                        <div class="preset-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="4 17 10 11 4 5"></polyline>
                                <line x1="12" y1="19" x2="20" y2="19"></line>
                            </svg>
                        </div>
                        <div class="preset-content">
                            <div class="preset-name">Custom Command</div>
                            <div class="preset-desc">Run any shell command</div>
                            <div class="preset-tags"><span class="preset-tag">Advanced</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="lumencanvas-config" class="config-panel">
                <span class="back-link" onclick="showPresetView()">&larr; Back</span>
                <h4>LumenCanvas Configuration</h4>
                <div class="input-group">
                    <label for="lc-url">Canvas URL or ID</label>
                    <input type="text" id="lc-url" placeholder="https://lumencanvas.studio/canvas/abc123">
                </div>
                <p class="section-label">Display Options</p>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="lc-kiosk" checked><label for="lc-kiosk">Kiosk mode</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="lc-webgpu" checked><label for="lc-webgpu">WebGPU acceleration</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="lc-autoplay" checked><label for="lc-autoplay">Auto-play media</label></div>
                </div>
                <button class="btn-primary" onclick="saveLumenCanvasConfig()">Save & Apply</button>
            </div>

            <div id="webgpu-config" class="config-panel">
                <span class="back-link" onclick="showPresetView()">&larr; Back</span>
                <h4>Web Kiosk Configuration</h4>
                <div class="input-group">
                    <label for="web-url">Website URL</label>
                    <input type="text" id="web-url" placeholder="https://example.com">
                </div>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="web-kiosk" checked><label for="web-kiosk">Kiosk mode</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="web-webgpu" checked><label for="web-webgpu">WebGPU acceleration</label></div>
                </div>
                <button class="btn-primary" onclick="saveWebKioskConfig()">Save & Apply</button>
            </div>

            <div id="custom-config" class="config-panel">
                <span class="back-link" onclick="showPresetView()">&larr; Back</span>
                <h4>Custom Command</h4>
                <div class="input-group">
                    <label for="startup-cmd">Startup Command</label>
                    <textarea id="startup-cmd" placeholder="DISPLAY=:0 chromium --kiosk https://example.com"></textarea>
                </div>
                <button class="btn-primary" onclick="saveCustomCommand()">Save & Apply</button>
            </div>
        </div>

        <!-- Schedule Tab -->
        <div id="schedule-tab" class="tab-content">
            <div class="timezone-display">
                <div class="timezone-label">Timezone</div>
                <div class="timezone-value" id="current-timezone">Loading...</div>
                <button class="btn-small" style="margin-top: 8px;" onclick="showTimezoneModal()">Change</button>
            </div>

            <div class="checkbox-item" style="margin-bottom: var(--space-lg);">
                <input type="checkbox" id="schedule-enabled" onchange="toggleSchedule()">
                <label for="schedule-enabled">Enable scheduling</label>
            </div>

            <p class="section-label">Schedule Rules</p>
            <div id="schedule-list" class="schedule-list">
                <div class="empty-state">No schedule rules yet</div>
            </div>

            <button class="btn-primary" onclick="showAddScheduleModal()">Add Schedule Rule</button>

            <div class="info-box">
                <h3>How Scheduling Works</h3>
                <p>Create rules to switch displays or refresh at specific times. Great for galleries, signage, and scheduled content.</p>
            </div>
        </div>
    </div>

    <!-- Add Network Modal -->
    <div class="modal-overlay" id="add-network-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Network</h3>
                <button class="modal-close" onclick="hideModal('add-network-modal')">&times;</button>
            </div>
            <form onsubmit="saveNewNetwork(); return false;" autocomplete="on">
                <div class="modal-body">
                    <div class="input-group">
                        <label for="new-network-ssid">Network Name (SSID)</label>
                        <input type="text" id="new-network-ssid" name="ssid" placeholder="MyWiFiNetwork" autocomplete="username">
                    </div>
                    <div class="input-group">
                        <label for="new-network-password">Password</label>
                        <input type="password" id="new-network-password" name="password" placeholder="Leave empty for open networks" autocomplete="new-password">
                    </div>
                    <div class="input-group">
                        <label for="new-network-notes">Notes (optional)</label>
                        <input type="text" id="new-network-notes" name="notes" placeholder="e.g., Gallery main office">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-primary">Save Network</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Schedule Modal -->
    <div class="modal-overlay" id="add-schedule-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Schedule Rule</h3>
                <button class="modal-close" onclick="hideModal('add-schedule-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="schedule-name">Rule Name</label>
                    <input type="text" id="schedule-name" placeholder="Morning Display">
                </div>
                <div class="input-group">
                    <label>Start Time</label>
                    <input type="time" id="schedule-start-time" value="08:00">
                </div>
                <div class="input-group">
                    <label>Days</label>
                    <div class="day-picker" id="schedule-days">
                        <button class="day-btn" data-day="mon" onclick="toggleDay(this)">Mon</button>
                        <button class="day-btn" data-day="tue" onclick="toggleDay(this)">Tue</button>
                        <button class="day-btn" data-day="wed" onclick="toggleDay(this)">Wed</button>
                        <button class="day-btn" data-day="thu" onclick="toggleDay(this)">Thu</button>
                        <button class="day-btn" data-day="fri" onclick="toggleDay(this)">Fri</button>
                        <button class="day-btn" data-day="sat" onclick="toggleDay(this)">Sat</button>
                        <button class="day-btn" data-day="sun" onclick="toggleDay(this)">Sun</button>
                    </div>
                </div>
                <div class="input-group">
                    <label for="schedule-action">Action</label>
                    <select id="schedule-action">
                        <option value="refresh">Refresh page</option>
                        <option value="switch_lumencanvas">Switch to LumenCanvas</option>
                        <option value="switch_webgpu">Switch to Web Kiosk</option>
                        <option value="switch_custom">Switch to Custom Command</option>
                        <option value="restart">Restart process</option>
                    </select>
                </div>
                <div class="input-group" id="schedule-until-group">
                    <label>End Time (optional)</label>
                    <input type="time" id="schedule-end-time" placeholder="Leave empty if no end">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="saveScheduleRule()">Add Rule</button>
            </div>
        </div>
    </div>

    <!-- Timezone Modal -->
    <div class="modal-overlay" id="timezone-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Set Timezone</h3>
                <button class="modal-close" onclick="hideModal('timezone-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="timezone-select">Timezone</label>
                    <select id="timezone-select">
                        <option value="auto">Auto-detect</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="saveTimezone()">Save</button>
            </div>
        </div>
    </div>

    <script>
        let selectedNetwork = null;
        let systemHostname = 'ossuary';
        let scheduleRules = [];
        let savedNetworks = [];

        // Initialize
        async function init() {
            loadNearbyNetworks();
            loadSavedNetworks();
            loadSchedule();
            loadTimezone();
            fetchSystemInfo();
            setInterval(loadNearbyNetworks, 15000);
        }

        async function fetchSystemInfo() {
            try {
                const response = await fetch('/api/system/info');
                if (response.ok) {
                    const info = await response.json();
                    systemHostname = info.hostname || 'ossuary';
                    document.getElementById('config-url').textContent = info.config_url || `http://${systemHostname}.local:8080`;
                }
            } catch (e) {
                document.getElementById('config-url').textContent = `http://${window.location.hostname}:8080`;
            }
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const tabMap = { wifi: 0, networks: 1, display: 2, schedule: 3 };
            document.querySelectorAll('.tab')[tabMap[tab]].classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');

            if (tab === 'networks') loadSavedNetworks();
            if (tab === 'schedule') loadSchedule();
        }

        function showMessage(id, text, type) {
            const msg = document.getElementById(id);
            if (msg) { msg.textContent = text; msg.className = `message ${type} show`; setTimeout(() => msg.classList.remove('show'), 5000); }
        }

        // Modal helpers
        function showModal(id) { document.getElementById(id).classList.add('show'); }
        function hideModal(id) { document.getElementById(id).classList.remove('show'); }
        function showAddNetworkModal() { showModal('add-network-modal'); }
        function showAddScheduleModal() { showModal('add-schedule-modal'); }
        function showTimezoneModal() { showModal('timezone-modal'); }

        // WiFi functions
        async function loadNearbyNetworks() {
            try {
                const response = await fetch('/networks');
                const networks = await response.json();
                const container = document.getElementById('nearby-networks');
                container.innerHTML = '';

                if (!networks || networks.length === 0) {
                    container.innerHTML = '<div class="empty-state">No networks found</div>';
                    return;
                }

                const lockIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`;
                const openIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><circle cx="12" cy="20" r="1"></circle></svg>`;

                networks.sort((a, b) => (b.signal || 0) - (a.signal || 0));
                networks.forEach(network => {
                    const ssid = network.ssid || network.SSID || 'Unknown';
                    const signal = network.signal || 0;
                    const item = document.createElement('div');
                    item.className = 'network-item';
                    item.innerHTML = `<div><div class="network-name">${ssid}</div><div class="network-meta">${signal}% signal</div></div><div class="network-icon">${network.encrypted !== false ? lockIcon : openIcon}</div>`;
                    item.onclick = () => selectWifiNetwork(ssid, item);
                    container.appendChild(item);
                });
            } catch (e) {
                document.getElementById('nearby-networks').innerHTML = '<div class="empty-state">Error loading networks</div>';
            }
        }

        function selectWifiNetwork(ssid, element) {
            document.querySelectorAll('#nearby-networks .network-item').forEach(i => i.classList.remove('selected'));
            element.classList.add('selected');
            selectedNetwork = ssid;
            document.getElementById('wifi-ssid').value = ssid;
            document.getElementById('wifi-connect-btn').textContent = `Connect to ${ssid}`;
        }

        async function connectWiFi() {
            const ssid = document.getElementById('wifi-ssid').value.trim() || selectedNetwork;
            const password = document.getElementById('wifi-password').value;

            if (!ssid) { showMessage('wifi-message', 'Please select or enter a network', 'error'); return; }

            const btn = document.getElementById('wifi-connect-btn');
            btn.disabled = true; btn.textContent = 'Connecting...';

            try {
                const response = await fetch('/connect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ssid, passphrase: password || '', identity: '' })
                });
                if (response.ok) {
                    showMessage('wifi-message', 'Connecting...', 'success');
                    // Also save to our list
                    await saveNetworkToList(ssid, password, '');
                } else {
                    showMessage('wifi-message', 'Connection failed', 'error');
                }
            } catch (e) {
                showMessage('wifi-message', e.message, 'error');
            } finally {
                btn.disabled = false; btn.textContent = 'Connect';
            }
        }

        // Saved networks
        async function loadSavedNetworks() {
            try {
                const response = await fetch('/api/saved-networks');
                const data = await response.json();
                // Merge config saved networks with NetworkManager networks
                const configNetworks = data.saved_networks || [];
                const nmNetworks = data.nm_networks || [];

                // Create a map of SSIDs we already have from config
                const configSSIDs = new Set(configNetworks.map(n => n.ssid));

                // Add NM networks that aren't in config
                savedNetworks = [...configNetworks];
                nmNetworks.forEach(nm => {
                    if (!configSSIDs.has(nm.ssid)) {
                        savedNetworks.push({ ssid: nm.ssid, from_nm: true });
                    }
                });

                renderSavedNetworks();
            } catch (e) {
                savedNetworks = [];
                renderSavedNetworks();
            }
        }

        function renderSavedNetworks() {
            const container = document.getElementById('saved-networks-list');
            if (!savedNetworks.length) {
                container.innerHTML = '<div class="empty-state">No saved networks</div>';
                return;
            }

            container.innerHTML = savedNetworks.map(n => `
                <div class="saved-network-item">
                    <div class="saved-network-info">
                        <div class="saved-network-ssid">${n.ssid}</div>
                        ${n.notes ? `<div class="saved-network-notes">${n.notes}</div>` : ''}
                        <div class="saved-network-meta">${n.from_nm ? 'Saved in system' : (n.last_connected ? 'Last: ' + new Date(n.last_connected).toLocaleDateString() : 'Never connected')}</div>
                    </div>
                    <div class="network-actions">
                        <button class="btn-small" onclick="connectSavedNetwork('${n.ssid}')">Connect</button>
                        ${!n.from_nm ? `<button class="btn-small danger" onclick="deleteNetwork('${n.ssid}')">Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function saveNetworkToList(ssid, password, notes) {
            try {
                await fetch('/api/saved-networks', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ssid, password, notes, auto_connect: true })
                });
            } catch (e) {}
        }

        async function saveNewNetwork() {
            const ssid = document.getElementById('new-network-ssid').value.trim();
            const password = document.getElementById('new-network-password').value;
            const notes = document.getElementById('new-network-notes').value.trim();

            if (!ssid) { alert('Network name required'); return; }

            try {
                await fetch('/api/saved-networks', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ssid, password, notes, auto_connect: true })
                });
                hideModal('add-network-modal');
                document.getElementById('new-network-ssid').value = '';
                document.getElementById('new-network-password').value = '';
                document.getElementById('new-network-notes').value = '';
                loadSavedNetworks();
            } catch (e) {
                alert('Failed to save network');
            }
        }

        async function connectSavedNetwork(ssid) {
            try {
                const response = await fetch('/api/saved-networks/connect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ssid })
                });
                if (response.ok) {
                    alert('Connected to ' + ssid);
                } else {
                    alert('Failed to connect');
                }
            } catch (e) {
                alert('Connection error');
            }
        }

        async function deleteNetwork(ssid) {
            if (!confirm(`Delete "${ssid}"?`)) return;
            try {
                await fetch('/api/saved-networks/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ssid, remove_from_system: true })
                });
                loadSavedNetworks();
            } catch (e) {}
        }

        // Display presets
        function selectPreset(preset) {
            document.getElementById('preset-view').style.display = 'none';
            document.querySelectorAll('.config-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`${preset}-config`).classList.add('active');
        }

        function showPresetView() {
            document.querySelectorAll('.config-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('preset-view').style.display = 'block';
        }

        async function saveCommand(command) {
            try {
                await fetch('/startup', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ command })
                });
                alert('Saved! Process will restart.');
            } catch (e) {
                localStorage.setItem('startup_command', command);
                alert('Saved locally');
            }
        }

        function buildLumenCanvasCommand() {
            let url = document.getElementById('lc-url').value.trim();
            if (url && !url.startsWith('http')) url = `https://lumencanvas.studio/canvas/${url}`;
            if (!url) url = 'https://lumencanvas.studio';

            let flags = ['--password-store=basic', '--disable-session-crashed-bubble', '--noerrdialogs', '--disable-infobars'];
            if (document.getElementById('lc-kiosk').checked) flags.push('--kiosk');
            if (document.getElementById('lc-webgpu').checked) flags.push('--enable-features=Vulkan,UseSkiaRenderer,WebGPU', '--enable-unsafe-webgpu', '--disable-gpu-sandbox');
            if (document.getElementById('lc-autoplay').checked) flags.push('--autoplay-policy=no-user-gesture-required');

            return `DISPLAY=:0 chromium ${flags.join(' ')} "${url}"`;
        }

        async function saveLumenCanvasConfig() { await saveCommand(buildLumenCanvasCommand()); }

        function buildWebKioskCommand() {
            const url = document.getElementById('web-url').value.trim() || 'https://example.com';
            let flags = ['--password-store=basic', '--noerrdialogs', '--disable-infobars'];
            if (document.getElementById('web-kiosk').checked) flags.push('--kiosk');
            if (document.getElementById('web-webgpu').checked) flags.push('--enable-features=Vulkan,UseSkiaRenderer,WebGPU', '--enable-unsafe-webgpu', '--disable-gpu-sandbox');
            return `DISPLAY=:0 chromium ${flags.join(' ')} "${url}"`;
        }

        async function saveWebKioskConfig() { await saveCommand(buildWebKioskCommand()); }
        async function saveCustomCommand() { await saveCommand(document.getElementById('startup-cmd').value.trim()); }

        // Schedule
        async function loadSchedule() {
            try {
                const response = await fetch('/api/schedule');
                const schedule = await response.json();
                document.getElementById('schedule-enabled').checked = schedule.enabled || false;
                scheduleRules = schedule.rules || [];
                renderScheduleRules();
            } catch (e) {
                scheduleRules = [];
                renderScheduleRules();
            }
        }

        function renderScheduleRules() {
            const container = document.getElementById('schedule-list');
            if (!scheduleRules.length) {
                container.innerHTML = '<div class="empty-state">No schedule rules yet</div>';
                return;
            }

            const dayNames = { mon: 'Mo', tue: 'Tu', wed: 'We', thu: 'Th', fri: 'Fr', sat: 'Sa', sun: 'Su' };
            const allDays = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

            container.innerHTML = scheduleRules.map((rule, idx) => `
                <div class="schedule-item ${rule.enabled === false ? 'disabled' : ''}">
                    <div class="schedule-info">
                        <div class="schedule-name">${rule.name || 'Rule ' + (idx + 1)}</div>
                        <div class="schedule-time">${rule.trigger?.time || '00:00'}${rule.until?.time ? ' - ' + rule.until.time : ''}</div>
                        <div class="schedule-days">
                            ${allDays.map(d => `<span class="schedule-day ${(rule.trigger?.days || []).includes(d) ? 'active' : ''}">${dayNames[d]}</span>`).join('')}
                        </div>
                        <div class="schedule-details">${rule.action?.type || 'refresh'}</div>
                    </div>
                    <div class="network-actions">
                        <button class="btn-small danger" onclick="deleteScheduleRule(${idx})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleDay(btn) {
            btn.classList.toggle('selected');
        }

        async function toggleSchedule() {
            const enabled = document.getElementById('schedule-enabled').checked;
            try {
                await fetch('/api/schedule', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ enabled, rules: scheduleRules })
                });
            } catch (e) {}
        }

        async function saveScheduleRule() {
            const name = document.getElementById('schedule-name').value.trim() || 'New Rule';
            const startTime = document.getElementById('schedule-start-time').value;
            const endTime = document.getElementById('schedule-end-time').value;
            const action = document.getElementById('schedule-action').value;

            const selectedDays = [];
            document.querySelectorAll('#schedule-days .day-btn.selected').forEach(btn => {
                selectedDays.push(btn.dataset.day);
            });

            if (selectedDays.length === 0) {
                alert('Please select at least one day');
                return;
            }

            const rule = {
                id: 'rule-' + Date.now(),
                name,
                enabled: true,
                trigger: { type: 'time', time: startTime, days: selectedDays },
                action: { type: action.startsWith('switch_') ? 'switch_profile' : action, profile: action.replace('switch_', '') }
            };

            if (endTime) {
                rule.until = { type: 'time', time: endTime };
            }

            scheduleRules.push(rule);

            try {
                await fetch('/api/schedule', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ enabled: document.getElementById('schedule-enabled').checked, rules: scheduleRules })
                });
                hideModal('add-schedule-modal');
                document.getElementById('schedule-name').value = '';
                document.querySelectorAll('#schedule-days .day-btn').forEach(btn => btn.classList.remove('selected'));
                renderScheduleRules();
            } catch (e) {
                alert('Failed to save rule');
            }
        }

        async function deleteScheduleRule(idx) {
            if (!confirm('Delete this rule?')) return;
            scheduleRules.splice(idx, 1);
            try {
                await fetch('/api/schedule', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ enabled: document.getElementById('schedule-enabled').checked, rules: scheduleRules })
                });
                renderScheduleRules();
            } catch (e) {}
        }

        // Timezone
        async function loadTimezone() {
            try {
                const response = await fetch('/api/timezone');
                const data = await response.json();
                document.getElementById('current-timezone').textContent = data.effective_timezone || 'Unknown';

                const select = document.getElementById('timezone-select');
                select.innerHTML = '<option value="auto">Auto-detect</option>';
                (data.available_timezones || []).forEach(tz => {
                    select.innerHTML += `<option value="${tz}">${tz}</option>`;
                });
                select.value = data.config_timezone || 'auto';
            } catch (e) {
                document.getElementById('current-timezone').textContent = 'Unknown';
            }
        }

        async function saveTimezone() {
            const timezone = document.getElementById('timezone-select').value;
            try {
                await fetch('/api/timezone', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ timezone })
                });
                hideModal('timezone-modal');
                loadTimezone();
            } catch (e) {
                alert('Failed to save timezone');
            }
        }

        window.onload = init;
    </script>
</body>
</html>
